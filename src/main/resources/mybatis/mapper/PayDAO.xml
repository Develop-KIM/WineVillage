<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.winevillage.winevillage.pay.IPayService">
	
	<!-- 주문자 정보 -->
	<select id="getOrderUserInfo"
		parameterType="com.winevillage.winevillage.pay.ParameterDTO"
		resultType="com.winevillage.winevillage.pay.PayDTO">
		  SELECT * FROM member WHERE memberNo = 2
	</select>
	
	<select id="listOrder"
		parameterType="com.winevillage.winevillage.pay.ParameterDTO"
		resultType="com.winevillage.winevillage.pay.PayDTO">
		SELECT *
			FROM (
 				 SELECT tb.*, ROWNUM rNum
 					 FROM (
 					   SELECT p.ProductName, p.DiscountPrice, m.Name, 
 					   			m.PhoneNumber, m.Points, o.orderAmount, m.Email, m.memberNo, m.address, p.productImg, p.wine, p.country
  						  FROM Orders o
   						 INNER JOIN Member m ON o.MemberNo = m.MemberNo
   						 INNER JOIN Product p ON o.ProductNo = p.ProductNo
  					) tb
			)
		WHERE memberNo = 2
	</select> 
	
	<insert id="write" parameterType="com.winevillage.winevillage.pay.PayDTO">
	  INSERT INTO Order_users (
	        order_usersNo,
	        name, email, phoneNumber, address, orderRequest,
	        discountPrice, 
	        orderAmount, points, finalPrice, memberNo,
	        receiverName, receiverPhone, receiverAddress
	    )
	    VALUES (
	        order_users_seq.NEXTVAL,
	        #{name}, #{email}, #{phoneNumber}, #{address}, #{orderRequest},
	        #{discountPrice},
	        #{orderAmount}, #{points}, #{finish_price_span}, 2,
	        #{re_name}, #{re_hp}, #{re_address}
	    )
	</insert>
	
	<insert id="writeRest" parameterType="com.winevillage.winevillage.pay.OrderDTO">
	
	    INSERT INTO order_users (
	        Order_usersNo, name, phoneNumber, address, orderRequest, 
	        discountPrice, orderAmount, points, finalPrice, memberNo,
	        receiverName, receiverPhone, receiverAddress;
	    ) VALUES (
	        order_users_seq.NEXTVAL, #{orderInfo.name},  #{orderInfo.phoneNumber}, #{orderInfo.address}, #{orderInfo.orderRequest},
	      <!--   #{orderItems[0].discountPrice}, #{orderItems[0].orderAmount}, #{usedPoints}, #{finalPrice}, #{memberNo}, -->
	        #{orderItems[0].discountPrice}, #{orderItems[0].orderAmount}, #{usedPoints}, #{finalPrice}, 2,
	        #{orderInfo.name}, #{orderInfo.phoneNumber}, #{orderInfo.address}
	    )
	   		<foreach collection="orderItems" item="item" index="index">
	        <if test="index > 0">
	            INSERT INTO order_details (
	                orderDetailNo, productId, productName, discountPrice, orderAmount
	            ) VALUES (
	                order_detail_seq, #{item.productId}, #{item.productName}, #{item.discountPrice}, #{item.orderAmount}
	            );
	        </if>
	   		</foreach>
	</insert>
	
</mapper>