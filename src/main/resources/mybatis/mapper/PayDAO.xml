<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.winevillage.winevillage.pay.IPayService">
	
<!-- 	<select id="memberView"
	resultType="com.winevillage.winevillage.pay.PayDTO"
	parameterType="com.winevillage.winevillage.pay.ParameterDTO">
	SELECT * FROM member WHERE memberId=#{memberId}
	</select> -->

	<!-- 게시물 갯수 -->
	<select id="totalCount" resultType="int"
		parameterType="com.winevillage.winevillage.pay.ParameterDTO">
		SELECT COUNT(*) FROM order_users
		<if test="searchKeyword!=null and !searchKeyword.equals('')">
			WHERE ${searchField} LIKE '%'||#{searchKeyword}||'%'
		</if>
	</select>
	
 	<!-- 주문자 정보 -->
<!-- 	<select id="getOrderUserInfo"
		parameterType="com.winevillage.winevillage.pay.ParameterDTO"
		resultType="com.winevillage.winevillage.pay.PayDTO">
		  SELECT * FROM member WHERE memberNo = 47
	</select> --> 
	
	<select id="listOrderUsers"
		resultType="com.winevillage.winevillage.pay.PayDTO"
		parameterType="com.winevillage.winevillage.pay.ParameterDTO">
		SELECT * FROM (
			SELECT Tb.*, rownum rNum FROM (
				SELECT * FROM order_users
				<if test="searchKeyword!=null and !searchKeyword.equals('')">
					WHERE ${searchField} LIKE '%'||#{searchKeyword}||'%'
				</if>
				ORDER BY order_usersno DESC
			)Tb
		)
		WHERE rNum<![CDATA[>=]]>#{start}
		AND rNum<![CDATA[<=]]>#{end}
	</select>
	
	<select id="listPage"
		resultType="com.winevillage.winevillage.product.ProductDTO"
		parameterType="com.winevillage.winevillage.product.ParameterDTO">
		SELECT * FROM (
		SELECT Tb.*, rownum rNum FROM (
		SELECT * FROM product
		<if test="searchKeyword!=null and !searchKeyword.equals('')">
			WHERE ${searchField} LIKE '%'||#{searchKeyword}||'%'
		</if>
		ORDER BY productno DESC
		)Tb
		)
		WHERE rNum<![CDATA[>=]]>#{start}
		AND rNum<![CDATA[<=]]>#{end}
	</select>
	
	<select id="listOrder"
	    parameterType="com.winevillage.winevillage.pay.ParameterDTO"
	    resultType="com.winevillage.winevillage.pay.OrderDTO">
	    SELECT p.ProductName, p.ProductImg, o.OrderAmount, p.wine, p.country, p.discountPrice, o.createDate, o.orderStatus
	    FROM Orders o
	    JOIN Member m ON o.MemberNo = m.MemberNo
	    JOIN Product p ON o.ProductNo = p.ProductNo
	    WHERE m.MemberNo = #{memberNo}
	</select>
	
	<select id="memberView" parameterType="string" resultType="com.winevillage.winevillage.pay.PayDTO">
	    SELECT MemberNo, MemberId, Name, PhoneNumber, Email, address1, address2, points
	    FROM Member
	    WHERE MemberId = #{memberId}
	</select>
	
	
<!-- 	<select id="listOrder"
		parameterType="com.winevillage.winevillage.pay.ParameterDTO"
		resultType="com.winevillage.winevillage.pay.PayDTO">
		SELECT *
			FROM (
 				 SELECT tb.*, ROWNUM rNum
 					 FROM (
 					   SELECT p.ProductName, p.DiscountPrice, m.Name, 
 					   			m.PhoneNumber, m.Points, o.orderAmount, m.Email, m.memberNo, m.address1, m.address2, p.productImg, p.wine, p.country, o.orderStatus, o.cookie_id
  						  FROM Orders o
   						 INNER JOIN Member m ON o.MemberNo = m.MemberNo
   						 INNER JOIN Product p ON o.ProductNo = p.ProductNo
  					) tb
			)
		WHERE  memberNo= #{memberNo}
	</select>  -->
	
	<insert id="write" parameterType="com.winevillage.winevillage.pay.PayDTO">
	  INSERT INTO Order_users (
	        order_usersNo,
	        name, email, phoneNumber, address1, orderRequest,
	        discountPrice, 
	        orderAmount, points, finalPrice, memberNo,
	        receiverName, receiverPhone, receiverAddress
	    )
	    VALUES (
	        order_users_seq.NEXTVAL,
	        #{name}, #{email}, #{phoneNumber}, #{address1}, #{orderRequest},
	        #{discountPrice},
	        #{orderAmount}, #{points}, #{finish_price_span}, 47,
	        #{re_name}, #{re_hp}, #{re_address1}
	    )
	</insert>
	
	<insert id="writeRest" parameterType="com.winevillage.winevillage.pay.OrderDTO">
		  INSERT INTO order_users (
		        Order_usersNo, name, email, phoneNumber, address1, orderRequest,
		        discountPrice, orderAmount, points, finalPrice, memberNo, productImg,
		        receiverName, receiverPhone, receiverAddress1, orderStatus
		    ) VALUES (
		        order_users_seq.NEXTVAL, #{orderInfo.name}, #{orderInfo.email}, #{orderInfo.phoneNumber}, #{orderInfo.address1}, #{orderInfo.orderRequest}, 
		        #{productItems[0].discountPrice}, #{productItems[0].orderAmount}, #{usedPoints}, #{finalPrice}, #{productItems[0].memberNo}, #{productItems[0].productImg},
		        #{orderInfo.re_name}, #{orderInfo.re_hp}, #{orderInfo.address1}, #{productItems[0].orderStatus}
		    )
    </insert>
		
		 <!--  <foreach collection="productItems" item="item" index="index">
		        <if test="index > 0">
		            INSERT INTO order_details (
		                orderDetailNo, productName, discountPrice, orderAmount
		            ) VALUES (
		                order_detail_seq.NEXTVAL, #{item.productName}, #{item.discountPrice}, #{item.orderAmount}
		            )
		        </if>
		   </foreach> -->
	
	<update id="updateOrderStatus" parameterType="com.winevillage.winevillage.pay.OrderDTO">
        UPDATE order_users
        SET orderStatus = 'PAYMENT_COMPLETED'
        WHERE createDate = #{orderInfo.createDate}
    </update>
    
    <delete id="deleteOrder" parameterType="com.winevillage.winevillage.pay.OrderDTO">
        DELETE FROM order_users
        WHERE createDate = #{orderInfo.createDate}
    </delete>
    
    <!-- <insert id="writeRest" parameterType="com.winevillage.winevillage.pay.OrderDTO">
		  INSERT INTO order_users (
		        Order_usersNo, name, email, phoneNumber, address1, orderRequest,
		        discountPrice, orderAmount, points, finalPrice, memberNo,
		        receiverName, receiverPhone, receiverAddress1, orderStatus, cookie_id
		    ) VALUES (
		        order_users_seq.NEXTVAL, #{orderInfo.name}, #{orderInfo.email}, #{orderInfo.phoneNumber}, #{orderInfo.address1}, #{orderInfo.orderRequest}, 
		        #{productItems[0].discountPrice}, #{productItems[0].orderAmount}, #{usedPoints}, #{finalPrice}, #{memberNo},
		        #{productItems[0].discountPrice}, #{productItems[0].orderAmount}, #{usedPoints}, #{finalPrice}, 47,
		        #{orderInfo.re_name}, #{orderInfo.re_hp}, #{orderInfo.address1}, #{orderStatus}, #{cookie_id}
		    )
		
		  <foreach collection="productItems" item="item" index="index">
		        <if test="index > 0">
		            INSERT INTO order_details (
		                orderDetailNo, productName, discountPrice, orderAmount
		            ) VALUES (
		                order_detail_seq.NEXTVAL, #{item.productName}, #{item.discountPrice}, #{item.orderAmount}
		            )
		        </if>
		    </foreach>
    </insert> -->
    
    
     
</mapper> 